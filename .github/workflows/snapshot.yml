name: Snapshot Release
permissions:
  contents: write  # å¿…éœ€æƒé™
  packages: write  # Docker é•œåƒæ¨é€æƒé™

on:
  push:
    branches: [ "**" ]  # è‡ªåŠ¨è§¦å‘ï¼šæ‰€æœ‰åˆ†æ”¯æäº¤
  workflow_dispatch:    # æ‰‹åŠ¨è§¦å‘å…¥å£ï¼ˆ[[11]](#__11)ï¼‰
    inputs:             # å¯é€‰ï¼šå®šä¹‰æ‰‹åŠ¨è§¦å‘æ—¶çš„è¾“å…¥å‚æ•°
      environment:
        description: 'æ‰‹åŠ¨å‘å¸ƒ'
        required: true
        default: 'stage'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²ï¼ˆ[[0]](#__0) [[10]](#__10)ï¼‰

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Extract package version
        id: package-version
        run: |
          VERSION=$(jq -r .version package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get short commit SHA
        id: commit-id
        run: echo "short_sha=$(git rev-parse --short=7 HEAD)" >> $GITHUB_OUTPUT

      - name: Build Transmission version
        run: pnpm run build:transmission

      - name: Build qBittorrent version
        run: pnpm run build:qbittorrent

      - name: Compress files to ZIP
        run: |
          # å‹ç¼© Transmission ç‰ˆæœ¬
          cd dist-transmission
          zip -r ../bitcake-${{ steps.package-version.outputs.version }}-transmission.zip .
          cd ..

          # å‹ç¼© qBittorrent ç‰ˆæœ¬ (åœ¨ public å­ç›®å½•ä¸­)
          cd dist-qbittorrent
          zip -r ../bitcake-${{ steps.package-version.outputs.version }}-qbittorrent.zip .
          cd ..

          # è¾“å‡ºæ–‡ä»¶è·¯å¾„ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "TRANSMISSION_ZIP=$(pwd)/bitcake-${{ steps.package-version.outputs.version }}-transmission.zip" >> $GITHUB_ENV
          echo "QBITTORRENT_ZIP=$(pwd)/bitcake-${{ steps.package-version.outputs.version }}-qbittorrent.zip" >> $GITHUB_ENV

      - name: Create Snapshot Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.package-version.outputs.version }}-${{ steps.commit-id.outputs.short_sha }}
          name: ${{ steps.package-version.outputs.version }}-${{ steps.commit-id.outputs.short_sha }}
          body: |
            Automated snapshot build from commit ${{ github.sha }}

            ## ğŸ“¦ Build Artifacts
            - `bitcake-${{ steps.package-version.outputs.version }}-transmission.zip` - Transmission å®¢æˆ·ç«¯ç‰ˆæœ¬
            - `bitcake-${{ steps.package-version.outputs.version }}-qbittorrent.zip` - qBittorrent å®¢æˆ·ç«¯ç‰ˆæœ¬

            ## ğŸ³ Docker Image
            ```bash
            docker pull ghcr.io/${{ github.repository_owner }}/bitcake:${{ steps.package-version.outputs.version }}-${{ steps.commit-id.outputs.short_sha }}
            docker pull ghcr.io/${{ github.repository_owner }}/bitcake:latest
            ```
          prerelease: true
          files: |
            ${{ env.TRANSMISSION_ZIP }}
            ${{ env.QBITTORRENT_ZIP }}

        env:
          GITHUB_TOKEN: ${{ secrets.DEPLOY_TOKEN }}

      # Docker é•œåƒæ„å»ºå’Œæ¨é€
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/bitcake
          tags: |
            type=raw,value=${{ steps.package-version.outputs.version }}-${{ steps.commit-id.outputs.short_sha }}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
